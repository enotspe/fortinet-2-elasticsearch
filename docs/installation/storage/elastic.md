# Elasticsearch

We got a script!!!! üéâ 

FortiDragon provides an automated script to set up all necessary Elasticsearch components.

## Prerequisites

- Elasticsearch running. Either [cluster](https://www.elastic.co/docs/deploy-manage/deploy/self-managed/installing-elasticsearch), [cloud](https://www.elastic.co/docs/deploy-manage/deploy/elastic-cloud/create-an-elastic-cloud-hosted-deployment) or [serverless](https://www.elastic.co/docs/deploy-manage/deploy/elastic-cloud/create-serverless-project)
- [Access](https://www.elastic.co/docs/deploy-manage/deploy/self-managed/install-elasticsearch-with-rpm#rpm-check-running) to Elasticsearch with appropriate permissions
- Curl

## Installation Steps

1. **Clone the repository**:
   ```bash
   git clone https://github.com/enotspe/fortinet-2-elasticsearch.git
   cd fortinet-2-elasticsearch
   ```

2. **Make the script executable**:
   ```bash
   chmod +x ELK/load.sh
   ```

3. **Modify variables according to your environment**:
Either on
    1. Script itself
    2. Via environment variables

4. **Run the installation script**:
   ```bash
   cd ELK
   ./load.sh
   ```

## Configuring Variables

### Set Elasticsearch

Define Elasticsearch endpoint
```ini
# Elasticsearch connection settings
ES_URL="${ES_URL:-https://localhost:9200}"
```

For local deployments, with autogenerated certificates, set `INSECURE` flag to `true`
```ini
# SSL certificate validation: "true" to bypass SSL validation, "false" to validate
INSECURE="${INSECURE:-false}"
```

Define user/pass
```ini
# User/Password authentication (used when AUTH_METHOD="user")
ES_USERNAME="${ES_USERNAME:-elastic}"
ES_PASSWORD="${ES_PASSWORD:-changeme}"
```

Or API key
```ini
# API Key authentication (used when AUTH_METHOD="apikey")
ES_API_KEY="${ES_API_KEY:-}"
```

### Set LOAD

Via `LOAD_*` variables, we control what modules are loaded to Elasticsearch.
By default, only [index](https://www.elastic.co/docs/manage-data/data-store/index-basics) related configuration is loaded. 

```ini
LOAD_ECS="${LOAD_ECS:-true}"
LOAD_COMPONENT="${LOAD_COMPONENT:-true}"
LOAD_ILM="${LOAD_ILM:-true}"
LOAD_INDEX_TEMPLATES="${LOAD_INDEX_TEMPLATES:-true}"
LOAD_INGEST_PIPELINES="${LOAD_INGEST_PIPELINES:-false}"
LOAD_TRANSFORMS="${LOAD_TRANSFORMS:-false}"
```


!!! warning "Ingest Pipelines"
    ‚ùå Ingest Pipelines had been deprecated in favor of Vector
    
    ‚úÖ **Deploy Vector instead**
    
!!! warning "Transforms"
    ‚ùå Transforms are not stable
    
    üò¨ We are probably not using them as they are intended to be

## What gets installed

The script automatically creates:

### Index Templates
- `logs-fortinet.fortigate.traffic`
- `logs-fortinet.fortigate.utm` 
- `logs-fortinet.fortigate.event`
- `logs-fortinet.forticlient`
- `logs-fortinet.fortiedr`
- `logs-fortinet.fortimail`

!!! info "Index Templates"
    You can manually add/remove component templates to the new created index templates

### Component Templates
- ECS field mappings
- Fortinet specific mappings
- ILM policies
- Index settings (refresh intervals, field limits, etc.)

### ILM Policies
Automated lifecycle management for each datastream type:

- `logs-fortinet.fortigate.traffic`
- `logs-fortinet.fortigate.utm` 
- `logs-fortinet.fortigate.event`
- `logs-fortinet.forticlient`
- `logs-fortinet.fortiedr`
- `logs-fortinet.fortimail`

### Ingest Pipelines
- `logs-fortinet.fortigate` - Main Fortigate log processing
- `logs-fortinet.forticlient` - FortiClient log processing
- `logs-fortinet.fortiedr` - FortiEDR log processing
- `logs-fortinet.fortimail` - FortiMail log processing
- `logs-fortinet.fortiweb` - FortiWeb log processing

!!! info "Ingest Pipelines"
    If **LOAD_INGEST_PIPELINES** is set to `true`

## Data Retention

Elasticsearch can manage data lifecycle either via:

- [Data stream lifecycle](https://www.elastic.co/docs/manage-data/lifecycle/data-stream)
- [ILM Policy](https://www.elastic.co/docs/manage-data/lifecycle/index-lifecycle-management/configure-lifecycle-policy)

!!! warning "Data stream lifecycle vs ILM Policies"
    Both options are set on created index templates
    
    ILM has precedence over Data stream lifecycle, so be sure to remove them from your index template if you don't intended to use them.

!!! info "Data stream lifecycle"
    Use them when you **do not** have a [data tiered](https://www.elastic.co/docs/manage-data/lifecycle/data-tiers) architecture

!!! info "ILM Policy"
    Use them when you **do** have a [data tiered](https://www.elastic.co/docs/manage-data/lifecycle/data-tiers) architecture
    
## Troubleshooting

| Problem | Solution |
|---------|----------|
|  |  |


## Next Steps

Once Elasticsearch is configured:


1. [Configure Vector](../ingest/vector.md)
2. [Start sending logs from Fortigate!](../datasource/fortigate.md)
3. [Load Kibana dashboards](../viz/kibana.md)

